https://linux1st.com/1012-boot-the-system.html

Weight: 3

part 1 https://www.youtube.com/watch?v=Zn_IGnNMHvc
## The Boot Process

1. motherboard _Firmware_ does PowerOnSelfTest (POST)
2. motherboard loads the _bootloader_
3. _bootloader_ loads _Linux Kernel_ based on its configs
4. _Kernel_ (_initramfs_) loads and prepare the system (root filesytem) and runs init programs
5. _Init_ start the service, other programs


### Firmwares

BIOS
- older, from HDD the MBR (1 sector) is used

UEFI
- modern
- specify a dedicated disk partition for bootloader called EFI System Partition (ESP)
- ESP has FAT filesystem, size could be like 1G
- mounted to `/boot/efi`, bootloader files `.efi` extension

### Bootloader

- initialises the minimum hardware needed to boot the system and finds and runs the OS
- common Linux bootloader is `grub` (default for Ubuntu/Debian) also `systemd-boot` (in my Arch installation)

### Kernel

- the core of OS, the LINUX itself
- Kernel needs some initial information on drivers for HW - these are in `initramfs`

#### `initramfs`

Temp root files system loaded into memory, acts as a bridge between the bootloader and the actual root filesystem, contains essential tools, drivers and modules to mount the real root filesystem.

---

part 2 https://www.youtube.com/watch?v=Sn20NKM0hbw

Kernel shows the boot process logs during the boot. It might be covered by a splash screen (just hit `ESC` key to show the logs).
## Commands

`dmesg`

- shows the full data from `kernel ring buffer` (what HW was detected, what drivers are loaded)
- sometimes stored as file in `/etc/log/dmesq` or in `/var/log/boot.log`

`journalctl`

- `journalctl -k` - show kernel log
- `journalctl -b` - show boot messages
- `journalctl --since "10min ago"`

### log file directories

- `/var/log/messages`
- `/var/log/boot`


## init

After kernel is done it starts Initialisation Daemon - `init`. It starts other programs, daemons, services etc.

Examples of init systems:

1. _SysVinit_ - read System Five (5) init
2. _systemd_
3. _upstart_

To find which init system is used - type `which init`:

``` FEDORA

root@vbox:~# cat /proc/version 
Linux version 6.14.0-63.fc42.x86_64 (mockbuild@d5701c6d040c430c8283c8c9847dc93f) (gcc (GCC) 15.0.1 20250228 (Red Hat 15.0.1-0), GNU ld version 2.44-3.fc42) #1 SMP PREEMPT_DYNAMIC Mon Mar 24 19:53:37 UTC 2025
root@vbox:~# which init
/usr/sbin/init
root@vbox:~# readlink -f /sbin/init 
/usr/lib/systemd/systemd
root@vbox:~# 
```

or check the PID 1 (always the init)

```
root@vbox:~# ps -p 1
    PID TTY          TIME CMD
      1 ?        00:00:02 systemd
```

also `pstree`

```
systemd-+-ModemManager---3*[{ModemManager}]
        |-NetworkManager---3*[{NetworkManager}]
        |-VBoxDRMClient---4*[{VBoxDRMClient}]
        |-VBoxService---8*[{VBoxService}]
        |-abrt-dbus---3*[{abrt-dbus}]
        |-3*[abrt-dump-journ]
        |-abrtd---3*[{abrtd}]
        |-accounts-daemon---3*[{accounts-daemon}]
        |-alsactl
        |-atd
        |-auditd---{auditd}
        |-avahi-daemon---avahi-daemon
        |-chronyd
        |-colord---3*[{colord}]
        |-crond
        |-cupsd
        |-dbus-broker-lau---dbus-broker
        |-firewalld---{firewalld}
        |-fwupd---3*[{fwupd}]
        |-gdm-+-gdm-session-wor-+-gdm-wayland-ses-+-gnome-session-b---4*[{gnome-session-b}]
        |     |                 |                 `-3*[{gdm-wayland-ses}]
        |     |                 `-3*[{gdm-session-wor}]
        |     `-3*[{gdm}]
        |-gnome-keyring-d---4*[{gnome-keyring-d}]
        |-gssproxy---5*[{gssproxy}]
        |-irqbalance---{irqbalance}
        |-low-memory-moni---3*[{low-memory-moni}]
        |-mcelog
        |-pcscd---7*[{pcscd}]
        |-polkitd---3*[{polkitd}]
        |-rsyslogd---2*[{rsyslogd}]
        |-rtkit-daemon---2*[{rtkit-daemon}]
        |-sssd_kcm
        |-switcheroo-cont---3*[{switcheroo-cont}]
        |-systemd---(sd-pam)
:

```

### systemd


- concept of units, many lives in `/etc/systemd/system`
- 12 unit types (automount, device, mount, path, scope, service, slice, snapshot, socker, swap, target, times)
- we use `systemctl` to work with the units

Units can live in:

1. `/etc/systemd/system`
2. `/run/systemd/system`
3. `/usr/lib/systemd/system`

```list systemd units of a specif type
systemctl list-units --type=service
```

```type=targets

root@vbox:/etc/systemd/system# systemctl get-default 
graphical.target
root@vbox:/etc/systemd/system# systemctl status graphical.target 
● graphical.target - Graphical Interface
     Loaded: loaded (/usr/lib/systemd/system/graphical.target; indirect; preset: disabled)
     Active: active since Thu 2025-05-15 20:25:59 CEST; 41min ago
 Invocation: 1828be959d08435d94bd1cad8c709e08
       Docs: man:systemd.special(7)

May 15 20:25:59 vbox systemd[1]: Reached target graphical.target - Graphical Interface.
root@vbox:/etc/systemd/system# systemctl cat graphical.target 
# /usr/lib/systemd/system/graphical.target
#  SPDX-License-Identifier: LGPL-2.1-or-later
#
#  This file is part of systemd.
#
#  systemd is free software; you can redistribute it and/or modify it
#  under the terms of the GNU Lesser General Public License as published by
#  the Free Software Foundation; either version 2.1 of the License, or
#  (at your option) any later version.

[Unit]
Description=Graphical Interface
Documentation=man:systemd.special(7)
Requires=multi-user.target
Wants=display-manager.service
Conflicts=rescue.service rescue.target
After=multi-user.target rescue.service rescue.target display-manager.service
AllowIsolate=yes
root@vbox:/etc/systemd/system# 

```

- `systemctl list-units` - list all units the system has
- `systemctl status|stop|start|enable|disable|restart|reload <unit>`

```
root@vbox:/etc/systemd/system# systemctl is-system-running 
running
```

## SystemVinit

---

Guided Exercises

1. On a machine equipped with a BIOS firmware, where is the bootstrap binary located? 

2. UEFI firmware supports extended features provided by external programs, called EFI applications. These applications, however, have their own special location. Where on the system would the EFI applications be located? 

3. Bootloaders allow the passing of custom kernel parameters before loading it. Suppose the system is unable to boot due to a misinformed root filesystem location. How would the correct root filesystem, located at /dev/sda3, be given as a parameter to the kernel? 

4. The boot process of a Linux machine ends up with the following message: ALERT! /dev/sda3 does not exist. Dropping to a shell! What is the likely cause of this problem?

Explorational Exercises 

1. The bootloader will present a list of operating systems to choose from when more than one operating system is installed on the machine. However, a newly installed operating system can overwrite the MBR of the hard disk, erasing the first stage of the bootloader and making the other operating system inaccessible. Why would this not happen on a machine equipped with a UEFI firmware? 

2. What is a common consequence of installing a custom kernel without providing an appropriate initramfs image? 

3. The initialization log is hundreds of lines long, so the output of dmesg command is often piped to a pager command — like command less — to facilitate the reading. What dmesg option will automatically paginate its output, eliminating the need to use a pager command explicitly? 

4. A hard drive containing the entire filesystem of an offline machine was removed and attached to a working machine as a secondary drive. Assuming its mount point is /mnt/hd, how would journalctl be used to inspect the contents of the journal files located at /mnt/hd/var/log/journal/?