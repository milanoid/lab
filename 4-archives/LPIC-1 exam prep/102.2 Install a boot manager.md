weight: 2

https://linux1st.com/1022-install-a-boot-manager.html

pt1 https://www.youtube.com/watch?v=G_FzcMZYDbg

## Install a boot manager

### boot overview

POST, 1st sector of MBR (512B)

https://wiki.archlinux.org/title/Arch_boot_process#Boot_loader

#### BIOS

`lilo` - BIOS legacy boot loader, fits completely in the 512B!
`grub`, `grub2` - smart or 2 stage boot loaders (too big for 512B)

#### UEFI

- UEFI stages
- FAT32 partition with executable PE file
- chain loading possible (one boot loader passing task to another boot loader)


### Grub (legacy)

Installed in MBR.

MBR limitations:

1. 4 primary partitions
2. or 3 primary with one extended partition
3. max disk size 2TB
4. only for PC BIOS

vs new GPT (GUID Partition Table)

- can work with both PC BIOS and UEFI
- its own partition ESP (EFI System Partition)

`/boot/grub`
`/boot/grub/menu.lst` - menu entries and settings
`/boot/grub/grub.conf` 


```
# This line is a comment
title My Linux Distribution
root (hd0,0)
kernel /vmlinuz root=/dev/hda1
initrd /initrd.img
```

`root (hd0,0)` - first disk, first partition

`grub-install /dev/sda`

`c` - open the grub command line mode
`e` - interactive editing environment


---

pt2. https://www.youtube.com/watch?v=lB-1orohGA0

## GRUB2

- `/boot/grub` or `/boot/grub2` on BIOS systems
- `/boot/efi/EFI/distro-name`

`/boot/grub/grub.cfg` - main configuration file, autogenerated, do not edit
`/etc/default/grub` - here make the changes, then run `updete-grup` utility
`/etc/grub.d` - place to add new boot menu entries

```
menuentry "Default OS" {
	set root=(hd0,1)
	linux /vmlinuz root=/dev/sda1 ro quiet splash
	initrd /initrd.img
}
```


`set root=(hd0,1) - first disk, first partition

The file has `if` and even functions - might be cumbersome to edit. Once all changes saved a convenient tool `grub-mkconfig` must be run. It will generates the final version of the config. 

Generate the configuration

`grub2-mkconfig > /boot/grub2/grub.cfg`
`grub2-mkconfig -o /boot/grub2/grub.cfg`

or `update-grub2` - a shortcut (Ubuntu only)

task - change boot menu display timeout to 10 seconds (Fedora VM)

1. `vi /etc/default/grub` (GRUB_TIMEOUT=10)
2. generate a new config `grub2-mkconfig > /boot/grub2/grub.cfg`

Menu entry example

```
 menuentry "Default OS" {
      set root=(hd0,1)
      linux /vmlinuz root=/dev/sda1 ro quiet splash
      initrd /initrd.img

}
```


Getting to Grub2 boot menu - either `ESC` or `SHIFT` or `F8`. Grub2 console `c` - a minimal grub shell allowing to edit the boot (e.g. selecting linux kernel and specify kernel parameters, specify initrd).

---
Guided Exercises

1. What is the default location for the GRUB 2 configuration file?
   `/boot/grub2/grub.cfg`
   
2. 1. What are the steps needed to change the settings for GRUB 2?
   
   Edit configuration file (e.g.`/etc/defaults/grub`) and then run `update-grub` or `grub2-mkconfig > /boot/grub2/grub.cfg`
   
3. Into which file should custom GRUB 2 menu entries be added?
   
   `/etc/grub.d/40_custom
   
5. Where are the menu entries for GRUB Legacy stored?
   
   `/boot/grub/menu.lst` or `/boot/grub/grub.conf`

6. From a GRUB 2 or GRUB Legacy menu, how can you enter the GRUB Shell?
   
   `c` - for console


Explorational Exercises

1. Imagine a user configuring GRUB Legacy to boot from the second partition of the first disk. He writes the following custom menu entry:
    
        title My Linux Distro
        root (hd0,2)
        kernel /vmlinuz root=/dev/hda1
        initrd /initrd.img
    
    However, the system will not boot. What is wrong?
    
    >> the correct partition spec is (hd0,1), the (hd0,2) would be 3rd partition
    
2. Imagine you have a disk identified as /dev/sda with multiple partitions. Which command can be used to find out which is the boot partition on a system?
   
   >> `lsblk`
   
3. Which command can be used to find out the UUID of a partition?
   
   >> `blkid`
   
4. Consider the following entry for GRUB 2
    
        menuentry "Default OS" {
            set root=(hd0,1)
    
            linux /vmlinuz root=/dev/sda1 ro quiet splash
    
            initrd /initrd.img
        }
    
    Change it so the system will boot from a disk with the UUID 5dda0af3-c995-481a-a6f3- 46dcd3b6998d
    
    
    >>menuentry "Default OS" {
            set root=(hd0,1)
    
            linux /vmlinuz root=UUID=5dda0af3-c995-481a-a6f3- 46dcd3b6998d ro quiet splash
    
            initrd /initrd.img
        }
    
5. How can you set GRUB 2 to wait for 10 seconds before booting the default menu entry?
   
   `vi /etc/default/grub` (GRUB_TIMEOUT=10)
   
6. From a GRUB Legacy shell, what are the commands to install GRUB to the first partition of the second disk?

```
grub> root (hd1,0)
grub> setup (hd1)
```



My task TODO:

in Fedora I have added a boot menu entry into `/etc/group.d/40_custom` + `grub2-mkconfig` and since than I cannot pass the boot menu (OOM). 

- boot in using Rescue Zilla, mount the fs (chroot might be needed) and repair the 40_custom file.


`mount /dev/sda3 /mnt/fedora

`for i in /dev /dev/pts /proc /sys /run; do sudo mount --bind $i /mnt/fedora$i; done
`