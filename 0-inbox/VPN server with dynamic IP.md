### The problem

I want to access my HomeLab from the internet securely. The VPN (Virtual Private Network) seems to be the good option. Having that set up I could connect in from anywhere and manage my home network resources, including my Kubernetes cluster.

But my ISP provides only dynamic IP address, which might change anytime. I would need to update my VPN client setting after every change of the IP. On top of that the ISP uses double NAT -- meaning the IPv4 address my router gets is not public but behind another NAT device managed by the ISP.

The good message is the ISP provides dual-stack IP - my router receives both IPv4 and IPv6 address. And the IPv6 is not affected by the double NAT. IPv6 the router gets is accessible from the internet. But remains dynamic and can change anytime.

I could buy a static IP from my ISP but that costs ~ 10 euros a month. I am not willing to pay that.


### Solution - dynamic DNS

As I have Cloudflare account with a registered domain `milanoud.net` I can use the Dynamic DNS. It allows to auto-update the A/AAAA DNS records anytime the ISP changes my IP address.

There is some plumbing needed:

#### Router setting

I have Asus RT-AX58U. It supports multiple VPN servers. I use Wireguard. 

The router has inbuilt Dynamic DNS. The feature works well but it is not configurable enough. It updates both IPv4 and IPv6. And once domain name has assigned both the IPv4 (A) and IPv6 (AAAA) the clients takes precedence for IPv4 which is behind the double NAT which breaks the VPN client connection.

#### ddclient

So instead the inbuilt dynamic DNS feature I use [ddclient](https://github.com/ddclient/ddclient). It is a recommended tool  by Cloudflare. The tool is a perl based script which does a curl request to a defined service and updates the Cloudflare DNS AAAA record via Cloudflare API.

The ddclient is not possible to install to Asus router itself (unless flashing the router to Merlin firmware). So I run the ddclient on Ubuntu Server (hpmini01). Resolving the IPv6 on the hpmini01 returns the system IPv6 though, not the public facing IPv6 assigned to my router.

To overcome this issue I set the ddclient to run a shell script via ssh on the Asus router itself!


##### ddclient configuration

The tool is installed as as systemd unit:

```bash
systemctl status ddclient.service
● ddclient.service - Update dynamic domain name service entries
     Loaded: loaded (/usr/lib/systemd/system/ddclient.service; enabled; preset: enabled)
     Active: active (running) since Sat 2025-08-23 18:06:20 UTC; 40min ago
       Docs: man:ddclient(8)
    Process: 1130299 ExecStart=/usr/bin/ddclient -daemon $daemon_interval -syslog -pid /run/ddclient.pid (code=exited, status=0/SUCCESS)
   Main PID: 1130302 (ddclient - slee)
      Tasks: 1 (limit: 8728)
     Memory: 17.5M (peak: 21.2M)
        CPU: 1.396s
     CGroup: /system.slice/ddclient.service
             └─1130302 "ddclient - sleeping for 10 seconds"

Aug 23 18:16:21 hpmini01 sudo[1130695]: pam_unix(sudo:session): session opened for user milan(uid=1000) by (uid=0)
Aug 23 18:16:22 hpmini01 sudo[1130695]: pam_unix(sudo:session): session closed for user milan
Aug 23 18:26:25 hpmini01 sudo[1131044]:     root : PWD=/ ; USER=milan ; COMMAND=/usr/bin/ssh asus 'curl -s https://api6.ipify.org'
Aug 23 18:26:25 hpmini01 sudo[1131044]: pam_unix(sudo:session): session opened for user milan(uid=1000) by (uid=0)
Aug 23 18:26:25 hpmini01 sudo[1131044]: pam_unix(sudo:session): session closed for user milan
Aug 23 18:26:28 hpmini01 ddclient[1131047]: SUCCESS:  updating vpn.milanoid.net: IPv6 address set to 2a00:1028:838a:1248:ac15:8c5:6d1a:da41
Aug 23 18:36:28 hpmini01 sudo[1131420]:     root : PWD=/ ; USER=milan ; COMMAND=/usr/bin/ssh asus 'curl -s https://api6.ipify.org'
Aug 23 18:36:28 hpmini01 sudo[1131420]: pam_unix(sudo:session): session opened for user milan(uid=1000) by (uid=0)
Aug 23 18:36:29 hpmini01 sudo[1131420]: pam_unix(sudo:session): session closed for user milan
Aug 23 18:36:32 hpmini01 ddclient[1131423]: SUCCESS:  updating vpn.milanoid.net: IPv6 address set to 2a00:1028:838a:1248:ac15:8c5:6d1a:da41
```

Main configuration file

```bash
sudo cat /etc/ddclient.conf
[sudo] password for milan:
# Configuration file for ddclient generated by debconf
#
# /etc/ddclient.conf

## debugging options
#verbose=yes
#debug=yes


### cloudflare options
protocol=cloudflare
login=token
password='cloudflare-token'
zone=milanoid.net
vpn.milanoid.net

### shell script which get the IPv6 of my router's WAN
usev6=cmdv6, cmdv6='/etc/ddclient_cmd_script.sh'
```


My custom shell script to run a curl command via ssh on a remote machine (Asus router)

```bash
sudo cat /etc/ddclient_cmd_script.sh

#!/bin/bash
sudo -u milan ssh asus "curl -s https://api6.ipify.org"
```

ddclient global configuration file - note the 10 minutes interval

```bash
sudo cat /etc/default/ddclient
# Configuration for ddclient scripts
# generated from debconf on Sat Aug 23 01:58:01 PM UTC 2025
#
# /etc/default/ddclient

# Set to "true" if ddclient should be run every time DHCP client ('dhclient'
# from package isc-dhcp-client) updates the systems IP address.
run_dhclient="false"

# Set to "true" if ddclient should be run every time a new ppp connection is
# established. This might be useful, if you are using dial-on-demand.
run_ipup="false"

# Set the time interval between the updates of the dynamic DNS name in seconds.
# This option only takes effect if the ddclient runs in daemon mode.
daemon_interval="10m"
```
### conclusion

I can connect to my VPN server from:

- MacBook Pro 2017 with WIreGuard client while connected to internet via cellular network (Vodafone)
- TODO: configure WireGuard client on Lenovo/Arch Linux
